<!DOCTYPE html>
<html>
  <head>
    <title>flamebearer</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <style>
      html,
      body {
        height: 100%;
      }

      body {
        font: 16px 'Helvetica Neue', sans-serif;
        margin: 0;
      }

      body.hover {
        background: #cfc;
      }

      h1 {
        font-size: 30px;
        margin: 30px 30px 15px;
      }

      h1 a {
        color: black;
        text-decoration: none;
      }

      h1 a:hover {
        text-decoration: underline;
      }

      #fire-icon {
        fill: #f53;
        width: 26px;
        height: 26px;
        vertical-align: -1px;
      }

      #intro {
        margin: 0 30px;
      }

      code {
        font-size: 13px;
        color: #444;
      }

      code span {
        color: #aaa;
      }

      #canvas {
        width: 100%;
      }

      #controls {
        display: none;
      }

      #search {
        margin-right: 10px;
      }

      label {
        font-size: 14px;
      }

      #highlight {
        position: absolute;
        pointer-events: none;
        background: #ffffff40;
      }

      .loaded #intro {
        display: none;
      }

      .loaded #header {
        display: flex;
        align-items: center;
        flex-flow: row wrap;
        padding: 7px 10px;
      }

      .loaded h1 {
        font-size: 22px;
        margin: 0 auto 0 0;
        flex-shrink: 0;
      }

      .loaded #fire-icon {
        width: 20px;
        height: 20px;
      }

      .loaded #controls {
        display: block;
        flex-shrink: 0;
      }

      #tooltip {
        position: absolute;
        pointer-events: none;
        background: #ffffff;
        white-space: nowrap;
        box-shadow: 1px 2px 4px 0px rgba(0, 0, 0, 0.3);
        border-radius: 2px;
        padding: 3px 5px;
        font: 12px Tahoma, sans-serif;
        display: none;
      }

      #tooltip .path {
        color: #888;
        font-size: 11px;
      }

      #tooltip .time {
        color: #4a4;
      }
    </style>
  </head>

  <body>
    <div id="header">
      <h1>
        <svg
          id="fire-icon"
          xmlns:svg="http://www.w3.org/2000/svg"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:xlink="http://www.w3.org/1999/xlink"
          viewBox="0 0 15 15"
          style="enable-background:new 0 0 15 15;"
          xml:space="preserve"
        >
          <path
            d="M7.5,0.5L5,4.5l-1.5-2 C2.9452,3.4753,0.8036,5.7924,0.8036,8.3036C0.8036,12.002,3.8017,15,7.5,15s6.6964-2.998,6.6964-6.6964 c0-2.5112-2.1416-4.8283-2.6964-5.8036l-1.5,2L7.5,0.5z M7.5,7c0,0,2.5,2.5618,2.5,4.5c0,0.8371-0.8259,2-2.5,2S5,12.3371,5,11.5 C5,9.6283,7.5,7,7.5,7z"
          />
        </svg>
        <a href="https://github.com/mapbox/flamebearer">flamebearer</a>
      </h1>
      <div id="controls">
        <input id="search" placeholder="Search..." />
        <button id="reset">Reset view</button><br />
        <input id="framework" type="checkbox" /><label for="framework">Include Framework</label><br />
        <input id="system" type="checkbox" /><label for="system">Include System</label>
      </div>
    </div>
    <div id="highlight"></div>
    <div id="tooltip"></div>
    <div id="intro">
      <!--  -->
    </div>
    <canvas id="canvas" height="0"></canvas>

    <!--  -->
    <script>const frameworkName = /~([a-zA-Z]{1,2}|[a-zA-Z]{1}\.[a-zA-Z]{1})[\. ]|~render |~\(anonymous\)|\(unknown\)|\~_{0,2}webpack/;
const systemName = /\(C\+\+\)|\(lib\)/;

function isFrameworkName(name) {
  return frameworkName.test(name);
}

function isSystemName(name) {
  return systemName.test(name);
}


'use strict';

const introEl = document.getElementById('intro');
const searchEl = document.getElementById('search');
const highlightEl = document.getElementById('highlight');
const tooltipEl = document.getElementById('tooltip');
const frameworkEl = document.getElementById('framework');
const systemEl = document.getElementById('system');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let names = ["(unknown)","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/react.production.min.js:1:1","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/react.production.min.js:9:23","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/react.production.min.js:9:179","(lib) C:\\git\\oufr-jg\\node_modules\\puppeteer\\.local-chromium\\win64-672088\\chrome-win\\chrome_child.dll","(unknown)","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:1","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:10","~r file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:33","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3483322","~(anonymous) :1:1","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:2057389","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3491678","~y.extend :31:18","~hb :32:12","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3088650","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:46613","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:1873904","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3061894","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:2066509","~keyframes :11:19","~serializeRuleEntries :378:30","~_makeSemanticColorsFromPalette :1172:40","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3611635","~(anonymous) :4:36","~webpackContext :26:24","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3613606","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:201883","~r.d file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:181","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3054999","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:2683435","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:141947","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:2046083","~Stylesheet.getInstance :57:39","(lib) C:\\WINDOWS\\SYSTEM32\\ntdll.dll","~styled :33:16","~(anonymous) :37:43","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:2586697","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3435617","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:2834004","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3048106","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:2674587","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3390173","~(anonymous) file:///C:/git/oufr-jg/apps/perf-test/dist/perf-test.js:1:3618902","~(anonymous) :6:49","~lib_initializeIcons :2289:29","~(anonymous) :2291:624","~initializeIcons :10:25","~fabric_icons_13_initializeIcons :1703:41","~registerIcons :94:23","~render :266:336","~Si :264:12","~Hi :251:12","~(anonymous) :264:339","~Pi.render :261:29","~Ki :253:42","~Ji :252:12","~qf :243:12","~Xh :245:83","~Yh :248:12","~Di :249:12","~ci :233:12","~bi :232:12","~Tg :177:12","~S :164:45","~(anonymous) :145:114","~v :142:337","~p :140:224","~Ye :122:12","~K :118:419","~Ue :118:12","~Af :136:12","~hg :150:12","~DetailsRowFields :10073:33","~(anonymous) :10077:164","~Og :167:12","~vf :132:12","~Qg :173:12","~DetailsRowBase.render :10247:48","~DetailsRowCheckBase :8698:36","~getClassNames :36:34","~_styles :73:41","~_resolve :90:18","~DetailsRowCheck_styles_getStyles :8656:49","~mergeStyleSets :16:24","~extractStyleParts :8:27","~CheckBase :11:26","~styleToRegistration :401:29","~Stylesheet.classNameFromKey :106:54","~getKeyForRules :362:24","~FocusZone.render :328:43","~ai :222:12","~FocusZone :54:23","~getId :98:15","~extractRules :284:22","~_loop_1 :313:44","~DetailsRowBase :10121:28","~createRef :21:372","~lh :194:140","~oe :106:12","~tc :55:12","~_traverseMap :89:22","~_traverseEdge :82:23","~_normalizeValue :108:25","~initializeComponentRef :10:32","~extendComponent :7:25","~appendFunction :7:24","~applyRegistration :427:27","~qc :49:12","~pc :48:127","~FontIcon :34:25","~css :7:13","~Wrapped._this._renderContent :42:45","~__rest :61:16","~Lf :148:288","~he :101:184","~ge :101:12","~M :15:11","~ke :103:12","~DetailsRow_styles_getStyles :8028:44","~xe :110:125","~getNativeProps :393:24","~filteredAssign :70:24","~_processArgs :16:26","~Stylesheet.argsFromClassName :113:55","~qe :107:12","~DetailsRowBase._onRenderCheck :10339:56","~Mf :148:385","~getStyles :14:26","~xf :134:12","~Wrapped.render :53:45","~getFocusStyle :738:23","~_getFocusStyleInternal :746:32","~Wrapped :39:25","~memoizedFunction :73:37","~getGlobalClassNames :946:29","~expandSelector :272:24","~Ng :166:128","~se :109:12","~Id :87:12","~expandQuads :355:21","~we :110:12","~getCellText :10061:28","~(anonymous) :398:92","~_fastDefaultCheckboxRender :8722:36","~(anonymous) :324:55","~Ve :119:12","~Customizations.getSettings :31:43","~If :147:394","~Ig :185:375","~ne :105:284","~Wrapped._updateStyles :66:52","~DetailsRowBase._getSelectionState :10342:60","~re :108:12","~FocusZone._evaluateFocusBeforeRender :405:63","~FocusZone._getDocument :816:49","~M :186:11","~get :22:31","~Je :114:12","~Selection.canSelectItem :25:50","~G :13:401","~(anonymous) :3:88","~(anonymous) :2:88","~oc :48:12","~concatStyleSets :6:25","~(anonymous) :1:88","~(anonymous) :323:51","~(anonymous) :1539:102","~J :114:349","~(anonymous) :220:88","~Selection.isIndexSelected :185:52","~expandCommaSeparatedGlobals :241:37","~E :13:11","~f :138:420","~Fi :250:12","~exports.unstable_runWithPriority :18:42","~(anonymous) :250:265","~Zh :219:12","~Uh :215:12","~Th :214:12","~Vh :216:12","~(anonymous) :15:21","~(anonymous) :20:36","~FocusZone.componentDidMount :274:54","~FocusZone._updateTabIndexes :724:54","~getDocument :12:21","~Wrapped.componentDidMount :56:56","~isElementFocusZone :238:28","~DetailsRowBase._this._onRootRef :10133:37","~findDOMNode :266:45","~hd :72:122","~gd :71:12","~ed :70:275","~isElementTabbable :208:27","~DetailsRowBase.componentDidMount :10178:59","~EventGroup.on :119:40","~getParent :11:19","~on :2:12","~EventGroup._isElement :96:38"];
let levels = [[0,1,0,0,2749,5],[0,1,1,0,2749,6],[0,1,2,0,2749,7],[0,1,3,0,2749,8],[0,1,4,0,2749,9],[1,2749,10],[1,1,4,0,16,8,0,2,45,0,2730,50],[1,1,4,0,1,11,0,3,15,0,12,23,0,2,4,0,2730,51],[1,1,4,0,1,10,0,3,10,0,12,10,0,2,46,0,2730,52],[2,1,8,0,3,8,0,12,4,0,1,47,0,1,48,0,2730,53],[2,1,12,0,3,16,0,12,24,0,1,4,0,1,49,0,2730,54],[2,1,10,0,3,10,0,12,25,0,1,4,0,1,4,0,2730,55],[2,1,13,0,1,8,0,1,20,0,1,22,0,12,8,1,1,4,0,2730,56],[2,1,14,0,1,17,0,1,21,0,1,4,0,11,26,0,1,43,2,2730,57],[2,1,4,0,1,10,0,1,4,0,1,4,0,11,10,0,1,10,2,2730,58],[3,1,8,2,11,8,0,1,4,2,2730,59],[3,1,18,2,11,27,0,1,44,2,2730,60],[3,1,10,2,1,4,0,10,10,0,1,4,2,1,4,0,2588,61,0,141,174],[3,1,8,2,1,4,0,2,4,0,3,8,0,4,28,0,1,35,0,1,4,2,1,4,0,6,4,0,2582,62,0,141,175],[3,1,19,3,1,4,0,1,34,0,1,29,0,1,37,0,1,41,0,4,4,0,1,36,10,59,4,0,2009,63,0,514,91,0,141,176],[3,1,10,5,1,10,0,1,10,0,1,10,0,4,4,0,1,4,65,4,4,0,65,4,0,118,64,0,663,72,0,1050,75,0,76,112,0,16,114,0,10,120,0,3,137,0,7,156,0,1,158,0,252,4,0,2,5,0,15,98,0,44,99,0,132,100,0,3,116,0,31,118,0,13,125,0,4,127,0,6,138,0,5,141,0,1,148,0,5,153,0,1,168,0,141,177],[3,1,8,5,1,8,0,1,8,0,1,8,4,1,4,67,1,4,0,1,34,63,2,4,0,11,4,0,107,65,0,15,4,0,56,73,0,276,79,0,263,86,0,53,110,0,10,4,0,64,76,0,960,77,0,13,129,0,2,149,0,1,168,0,21,4,0,19,113,0,18,117,0,8,147,0,9,151,0,1,161,0,6,4,0,9,115,0,1,148,0,10,4,0,3,4,0,7,4,0,1,4,246,6,4,0,2,4,0,15,4,0,22,4,0,18,5,0,4,150,0,106,4,0,21,108,0,5,163,0,3,4,0,6,4,0,25,5,0,13,4,0,4,4,0,2,4,0,1,5,0,3,139,0,5,4,0,1,4,0,5,4,0,1,4,0,1,4,0,2,178,0,2,179,0,136,180],[3,1,4,5,1,30,0,1,38,0,1,42,150,32,4,0,50,66,0,24,68,0,1,71,15,54,4,0,2,117,0,19,4,0,230,80,0,3,111,0,4,113,0,14,117,0,5,144,0,1,162,0,5,4,0,249,80,0,9,117,0,16,4,0,9,111,0,4,117,0,20,121,0,3,134,0,1,165,10,9,4,0,18,92,0,23,96,0,14,133,0,17,4,0,33,64,0,825,78,0,74,90,0,9,130,0,2,137,0,12,4,0,1,158,0,2,4,0,1,4,19,2,4,0,19,4,0,18,4,0,8,4,0,9,4,0,1,4,6,4,4,0,5,116,0,1,4,289,1,4,12,10,4,0,18,4,0,4,4,83,23,4,0,3,4,0,18,109,0,5,4,9,25,4,19,1,4,0,3,4,10,1,4,2,2,4,0,2,4,0,8,4,0,122,181,0,3,186,0,3,188],[3,1,4,5,1,10,0,1,10,0,1,10,182,10,4,0,38,67,0,2,173,0,4,4,0,19,69,0,1,146,0,1,4,20,1,34,0,48,74,0,2,4,14,5,4,0,8,4,0,37,81,0,171,84,0,14,101,0,3,4,0,4,4,0,14,4,0,5,134,0,1,4,5,5,4,0,24,81,0,213,84,0,7,101,0,9,4,16,9,4,0,4,4,0,4,4,0,14,122,0,2,161,0,3,4,0,1,4,19,8,4,0,4,93,0,6,104,0,8,4,0,1,97,0,10,104,0,3,152,0,1,172,0,12,4,0,2,160,17,2,4,0,31,65,0,34,4,0,731,80,0,32,117,0,16,121,0,10,126,0,2,159,0,24,4,0,5,111,0,18,117,0,21,121,0,6,154,0,4,4,0,5,117,0,2,4,12,1,4,35,8,4,32,3,4,11,5,4,312,1,4,131,18,4,72,1,4,13,1,4,0,122,4,0,3,4,0,3,189],[9,1,8,0,1,8,0,1,28,192,12,4,0,24,68,0,2,71,0,2,4,4,3,4,0,16,70,0,1,4,22,22,4,0,11,111,0,12,117,0,3,142,29,37,82,0,23,4,0,25,85,0,117,87,0,4,107,0,2,164,0,9,4,0,5,102,2,1,4,3,1,4,14,5,4,11,24,82,0,27,4,0,21,85,0,161,87,0,3,107,0,1,164,0,2,4,0,5,102,31,3,4,8,10,4,0,4,143,0,2,4,26,5,4,0,4,4,0,1,4,0,5,105,4,4,4,0,1,4,0,10,105,0,2,4,0,1,170,0,1,4,1,10,4,0,1,34,0,2,4,19,7,4,0,23,68,0,1,71,25,9,4,0,9,4,0,95,81,0,620,84,0,7,101,0,32,4,0,2,4,0,14,122,0,3,4,0,7,117,0,2,4,10,14,4,0,5,4,0,18,4,0,1,4,0,20,122,0,2,4,0,3,5,0,1,155,4,5,4,661,119,182,3,1,4,0,2,190],[9,1,31,0,1,39,0,1,4,204,2,4,0,19,69,0,3,146,0,2,4,9,16,4,41,4,4,0,11,4,0,12,4,0,3,4,29,11,4,0,26,83,17,6,4,0,6,4,0,4,33,0,15,123,0,9,4,0,3,88,0,42,89,0,63,94,0,3,4,0,1,33,0,2,4,9,2,4,0,3,103,37,4,4,0,20,128,22,5,4,0,3,4,0,4,33,0,14,123,0,14,4,0,3,33,0,9,88,0,40,89,0,95,94,0,3,4,0,1,4,2,5,4,52,4,4,34,3,4,1,3,4,0,2,106,8,1,4,0,6,4,0,4,106,2,1,4,41,6,4,0,16,69,0,1,146,0,1,4,43,1,4,0,94,82,0,72,4,0,57,85,0,476,87,0,13,107,0,1,164,0,1,169,0,4,4,0,3,102,34,8,4,0,6,143,2,1,4,0,7,4,18,8,4,4,1,4,13,5,4,1,8,4,0,12,143,2,3,4,0,1,4,670,2,4,0,107,183,0,10,194,4,1,4,0,1,191],[9,1,10,0,1,10,0,1,4,206,3,4,0,16,70,0,3,4,80,3,4,55,6,4,0,12,131,0,8,135,29,4,4,0,3,4,0,12,123,9,3,4,0,42,4,0,12,4,0,3,33,0,48,94,3,1,5,11,2,4,0,3,4,41,16,4,0,4,135,30,3,4,0,1,5,0,3,4,0,10,123,0,1,124,14,3,4,0,9,4,0,40,4,0,11,4,0,2,33,0,82,94,7,4,4,54,2,4,41,2,4,15,4,4,50,4,4,0,12,70,0,1,4,45,5,4,0,89,119,56,16,4,0,20,4,0,4,33,0,33,123,0,28,4,0,4,33,0,16,88,0,112,89,0,315,94,0,1,162,0,9,4,0,4,33,0,1,4,0,1,4,4,3,4,42,6,4,68,12,4,678,11,4,0,1,5,0,4,155,0,89,184,0,1,196,0,1,197,0,4,4,0,6,195,5,1,192],[9,1,8,0,1,8,210,16,4,144,3,4,0,2,4,0,10,132,0,1,4,0,7,134,36,7,4,0,5,123,9,3,4,30,12,4,8,4,4,0,3,4,0,19,4,0,20,95,0,9,140,3,1,4,66,5,4,0,2,34,0,2,4,0,2,134,33,1,4,3,8,4,0,2,124,0,1,4,17,9,4,31,9,4,11,1,4,0,1,5,0,25,4,0,57,95,183,12,4,51,56,4,0,25,131,0,6,135,0,1,157,0,1,167,71,1,4,20,3,4,0,1,5,0,13,4,0,20,123,28,2,4,0,2,5,0,16,4,0,112,4,0,46,4,0,1,33,0,268,94,0,1,4,9,3,4,0,1,5,7,2,4,43,5,4,74,6,4,683,6,4,0,1,4,0,2,4,0,2,185,0,4,4,0,3,5,0,77,184,0,4,187,0,1,193,0,1,4,0,1,4,4,5,4,0,1,198,5,1,4],[9,1,32,0,1,40,375,10,4,1,7,4,38,5,4,0,3,4,0,1,123,0,1,124,84,3,4,0,1,34,0,3,4,0,16,94,0,1,136,0,9,4,79,2,4,43,2,4,0,2,4,79,1,4,25,37,4,0,15,94,0,2,136,0,3,171,277,21,4,0,4,34,0,2,4,0,23,132,0,4,4,0,2,134,0,1,4,0,1,4,95,1,4,13,12,4,0,6,123,0,2,124,30,2,4,2,14,4,79,33,4,38,8,4,0,1,4,0,63,4,0,5,33,0,184,95,0,15,140,0,1,162,13,1,4,8,1,4,815,2,4,3,2,4,4,3,4,0,6,4,0,28,5,0,33,184,0,4,187,0,6,193,0,4,4,0,1,5,1,1,4,9,1,4],[9,1,10,0,1,4,383,2,4,46,5,4,1,2,4,0,1,123,0,1,4,91,13,4,0,3,95,0,1,4,5,4,4,125,1,4,118,5,4,0,19,145,0,2,166,0,15,4,0,2,4,0,3,4,304,23,4,4,2,4,123,3,4,0,3,124,0,2,4,159,1,4,110,4,4,0,1,5,0,32,4,0,142,94,0,10,136,0,15,4,0,1,4,858,27,4,0,1,34,0,5,4,0,11,5,0,16,184,0,1,193,0,4,4,0,5,4,0,1,5,3,1,4,0,1,4],[9,1,33,0,1,4,438,1,4,0,1,4,0,1,4,103,1,34,0,1,4,0,2,94,0,1,4,253,5,4,0,2,4,0,9,94,0,8,136,0,2,4,5,9,4,0,1,34,3,2,4,317,7,4,0,3,34,132,3,4,276,1,4,30,2,4,0,74,4,0,3,33,0,65,95,0,10,4,4,11,4,892,11,4,0,1,4,0,7,5,0,7,184,0,1,193,0,1,4,1,3,4,5,1,4],[9,1,4,547,2,4,261,7,4,0,2,33,0,8,4,20,2,4,835,7,4,0,3,34,0,3,4,0,14,4,0,47,94,0,4,136,9,1,4,919,7,4,0,7,5,0,1,4],[9,1,4,548,1,4,268,1,4,0,1,5,4,4,4,883,1,4,0,35,4,0,6,33,0,6,95,0,4,4,936,7,4],[828,1,4,917,7,4,0,3,34,0,5,4,0,1,5,0,2,4,0,4,94,3,1,4],[1761,1,4,2,2,4,0,2,33],[1765,1,4,0,2,4]];
let numTicks = 2750;


let rangeMin = 0;
let rangeMax = 1;
let topLevel = 0;
let query = '';
let showFramework = false;
let showSystem = false;
let graphWidth, pxPerTick;

const pxPerLevel = 18;
const collapseThreshold = 1;
const hideThreshold = 0.5;
const labelThreshold = 20;

let numTopLevelTicks = numTicks;

highlightEl.style.height = pxPerLevel + 'px';

if (levels) {
  init();
}

function init() {
  document.body.classList.add('loaded');

  // delta-decode bar positions
  for (const level of levels) {
    let prev = 0;
    for (let i = 0; i < level.length; i += 3) {
      level[i] += prev;
      prev = level[i] + level[i + 1];
    }
  }

  updateFromHash();
  render();
}

window.onhashchange = () => {
  updateFromHash();
  render();
};
canvas.onclick = e => {
  const { i, j } = xyToBar(e.offsetX, e.offsetY);
  if (j === -1) return;
  window.location.hash = [i, j].join(',');
  removeHover();
};
document.getElementById('reset').onclick = () => {
  searchEl.value = query = '';
  window.location.hash = '';
  render();
};
window.onresize = render;

searchEl.oninput = e => {
  query = e.target.value;
  render();
};

frameworkEl.onchange = e => {
  showFramework = frameworkEl.checked;
  render();
};

systemEl.onchange = e => {
  showSystem = systemEl.checked;
  render();
};

function updateFromHash() {
  const [i, j] = window.location.hash
    .substr(1)
    .split(',')
    .map(Number);

  if (!isNaN(i) && !isNaN(j)) {
    topLevel = i;
    numTopLevelTicks = levels[i][j + 1];
    rangeMin = levels[i][j] / numTicks;
    rangeMax = (levels[i][j] + levels[i][j + 1]) / numTicks;
  } else {
    topLevel = 0;
    numTopLevelTicks = numTicks;
    rangeMin = 0;
    rangeMax = 1;
  }
}

function tickToX(i) {
  return (i - numTicks * rangeMin) * pxPerTick;
}

function render() {
  if (!levels) return;

  graphWidth = canvas.width = canvas.clientWidth;
  canvas.height = pxPerLevel * (levels.length - topLevel);
  canvas.style.height = canvas.height + 'px';

  if (devicePixelRatio > 1) {
    canvas.width *= 2;
    canvas.height *= 2;
    ctx.scale(2, 2);
  }

  pxPerTick = graphWidth / numTicks / (rangeMax - rangeMin);

  ctx.textBaseline = 'middle';
  ctx.font = '10px Tahoma, sans-serif';
  ctx.strokeStyle = 'white';

  for (let i = 0; i < levels.length - topLevel; i++) {
    const level = levels[topLevel + i];

    for (let j = 0; j < level.length; j += 3) {
      const barIndex = level[j];
      const x = tickToX(barIndex);
      const y = i * pxPerLevel;
      let numBarTicks = level[j + 1];

      const inQuery = (query && names[level[j + 2]].indexOf(query) >= 0) || false;

      // merge very small blocks into big "collapsed" ones for performance
      // const collapsed = numBarTicks * pxPerTick <= collapseThreshold;
      const collapsed = (!showFramework && isFrameworkName(names[level[j + 2]])) || (!showSystem && isSystemName(names[level[j + 2]]));
      if (collapsed) {
        while (
          j < level.length - 3 &&
          barIndex + numBarTicks === level[j + 3] &&
          level[j + 4] * pxPerTick <= collapseThreshold &&
          inQuery === ((query && names[level[j + 5]].indexOf(query) >= 0) || false)
        ) {
          j += 3;
          numBarTicks += level[j + 1];
        }
      }

      const sw = numBarTicks * pxPerTick - (collapsed ? 0 : 0.5);
      const sh = pxPerLevel - 0.5;

      if (x < -1 || x + sw > graphWidth + 1 || sw < hideThreshold) continue;

      ctx.beginPath();
      ctx.rect(x, y, sw, sh);

      const ratio = numBarTicks / numTopLevelTicks;

      if (!collapsed) {
        ctx.stroke();
        const intensity = Math.min(1, (ratio * Math.pow(1.16, i)) / (rangeMax - rangeMin));
        const h = 50 - 50 * intensity;
        const l = 65 + 7 * intensity;
        ctx.fillStyle = inQuery ? 'lightgreen' : `hsl(${h}, 100%, ${l}%)`;
      } else {
        ctx.fillStyle = inQuery ? 'lightgreen' : '#eee';
      }
      ctx.fill();

      if (!collapsed && sw >= labelThreshold) {
        const percent = Math.round(10000 * ratio) / 100;
        const name = `${names[level[j + 2]]} (${percent}%, ${numBarTicks} samples)`;

        ctx.save();
        ctx.clip();
        ctx.fillStyle = 'black';
        ctx.fillText(name, Math.max(x, 0) + 1, y + sh / 2);
        ctx.restore();
      }
    }
  }
}

// pixel coordinates to bar coordinates in the levels array
function xyToBar(x, y) {
  const i = Math.floor(y / pxPerLevel) + topLevel;
  const j = binarySearchLevel(x, levels[i]);
  return { i, j };
}

// binary search of a block in a stack level
function binarySearchLevel(x, level) {
  let i = 0;
  let j = level.length - 3;
  while (i <= j) {
    const m = 3 * ((i / 3 + j / 3) >> 1);
    const x0 = tickToX(level[m]);
    const x1 = tickToX(level[m] + level[m + 1]);
    if (x0 <= x && x1 >= x) {
      return x1 - x0 > collapseThreshold ? m : -1;
    }
    if (x0 > x) {
      j = m - 3;
    } else {
      i = m + 3;
    }
  }
  return -1;
}

if (window.orientation === undefined) {
  canvas.onmousemove = addHover;
  canvas.onmouseout = window.onscroll = removeHover;
}

function removeHover() {
  canvas.style.cursor = '';
  highlightEl.style.display = 'none';
  tooltipEl.style.display = 'none';
}

function addHover(e) {
  const { i, j } = xyToBar(e.offsetX, e.offsetY);

  if (j === -1 || e.offsetX < 0 || e.offsetX > graphWidth) {
    removeHover();
    return;
  }

  canvas.style.cursor = 'pointer';

  const level = levels[i];
  const x = tickToX(level[j]);
  const y = (i - topLevel) * pxPerLevel;
  const sw = tickToX(level[j] + level[j + 1]) - x;

  highlightEl.style.display = 'block';
  highlightEl.style.left = x + 'px';
  highlightEl.style.top = canvas.offsetTop + y + 'px';
  highlightEl.style.width = sw + 'px';

  const numBarTicks = level[j + 1];
  const percent = Math.round((10000 * numBarTicks) / numTopLevelTicks) / 100;
  const time = `<span class="time">(${percent}%, ${numBarTicks} samples)</span>`;
  let content = names[level[j + 2]];
  if (content[0] !== '(') content = content.replace(' ', ` ${time}<br><span class="path">`) + '</span>';
  else content += ` ${time}`;

  tooltipEl.innerHTML = content;
  tooltipEl.style.display = 'block';
  tooltipEl.style.left = Math.min(e.offsetX + 15 + tooltipEl.clientWidth, graphWidth) - tooltipEl.clientWidth + 'px';
  tooltipEl.style.top = canvas.offsetTop + e.offsetY + 12 + 'px';
}

// (function frame() { if (levels) render(); requestAnimationFrame(frame); })();


</script>
  </body>
</html>
